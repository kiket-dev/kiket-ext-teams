model_version: "1.0"
extension:
  id: dev.kiket.ext.teams
  name: Microsoft Teams Notifications
  version: 1.0.0
  description: Send notifications via Microsoft Teams channels and chats using Microsoft Graph API
  author: Kiket Team
  homepage: https://github.com/kiket-dev/kiket-ext-teams
  delivery: http
  callback:
    url: ${EXTENSION_BASE_URL}
    secret: env.KIKET_WEBHOOK_SECRET
    timeout: 30000
    required: true
  activationEvents:
    - issue.created
    - issue.transitioned
    - issue.assigned
    - issue.commented
    - workflow.sla_breach
    - workflow.before_transition
  permissions:
    - issues:read
    - users:read
    - notifications:write
    - workflows:read
  capabilities:
    - notifications
    - chat
    - direct-messages
    - channels
    - group-chat
    - rich-formatting
    - attachments
    - threading
    - adaptive-cards
    - approvals
  # Optional shared OAuth - if microsoft-oauth is installed, can use delegated tokens for user-specific features
  requires:
    oauth_provider:
      provider: microsoft-oauth
      scopes:
        - Chat.ReadWrite
        - ChannelMessage.Send
      on_missing: ignore  # Falls back to client_credentials flow
      optional: true
  hooks:
    - event: issue.created
      template: issue_created_message
      timeout: 5000
      retries: 1
      description: Send notification when issue is created
    - event: issue.transitioned
      timeout: 5000
      retries: 1
      description: Send notification on issue state transitions
    - event: issue.assigned
      timeout: 5000
      retries: 1
      description: Notify users when assigned to issues
    - event: issue.commented
      timeout: 5000
      retries: 1
      description: Send notification for new comments
    - event: workflow.sla_breach
      template: sla_breach_message
      timeout: 5000
      retries: 2
      description: Alert teams of SLA violations
    - event: workflow.before_transition
      template: approval_request_message
      timeout: 8000
      retries: 1
      description: Request approvals before workflow transitions
  contributes:
    commands:
      - command: teams.sendMessage
        title: Send Teams Message
        description: Send a message to a Microsoft Teams channel or chat
        category: Notifications
        icon: bi-microsoft-teams
        keywords: ["teams", "chat", "message", "notify", "microsoft"]
        handler:
          type: extension_event
          event: teams.sendMessage
      - command: teams.sendAdaptiveCard
        title: Send Adaptive Card
        description: Send a rich adaptive card to Teams
        category: Notifications
        icon: bi-card-text
        keywords: ["teams", "adaptive", "card", "rich"]
        handler:
          type: extension_event
          event: teams.sendAdaptiveCard
      - command: teams.sendThreadedMessage
        title: Send Threaded Reply
        description: Send a threaded reply to an existing message
        category: Notifications
        icon: bi-chat-dots
        keywords: ["teams", "thread", "reply", "message"]
        handler:
          type: extension_event
          event: teams.sendThreadedMessage
      - command: teams.validateChannel
        title: Validate Teams Channel
        description: Test Teams channel or user configuration
        category: Settings
        icon: bi-check-circle
        keywords: ["teams", "validate", "test", "channel"]
        handler:
          type: extension_event
          event: teams.validateChannel
      - command: teams.requestApproval
        title: Request Approval in Teams
        description: Send an interactive approval request via adaptive card
        category: Workflows
        icon: bi-hand-thumbs-up
        keywords: ["teams", "approval", "workflow", "request"]
        permissions:
          - manager
          - executive
        handler:
          type: extension_event
          event: teams.requestApproval
  configuration:
    # Authentication - org-wide credentials (shared across all projects)
    TEAMS_TENANT_ID:
      type: string
      secret: true
      required: true
      scope: extension
      label: Tenant ID
      description: Microsoft Entra ID (Azure AD) Tenant ID
    TEAMS_CLIENT_ID:
      type: string
      secret: true
      required: true
      scope: extension
      label: Client ID
      description: Microsoft Entra ID Application (Client) ID
    TEAMS_CLIENT_SECRET:
      type: string
      secret: true
      required: true
      scope: extension
      label: Client Secret
      description: Microsoft Entra ID Client Secret
    # General Settings
    default_message_format:
      type: string
      default: "html"
      description: Default message format (html or plain)
    retry_attempts:
      type: integer
      default: "3"
      description: Number of retry attempts for failed deliveries
    timeout_seconds:
      type: integer
      default: "30"
      description: Request timeout in seconds
    # Rich Configuration - Message Templates
    issue_created_message:
      type: template
      editor: template
      language: liquid
      label: Issue Created Message
      description: Teams message template for new issues
      default: |
        **New Issue Created**

        **{{ issue.title }}**
        Type: {{ issue.type }} | Priority: {{ issue.priority }}
        Created by: {{ issue.created_by.name }}

        {% if issue.description %}
        > {{ issue.description }}
        {% endif %}

        [View Issue]({{ issue.url }})
      variables:
        - name: issue
          type: object
          properties:
            - { name: id, type: number }
            - { name: title, type: string }
            - { name: type, type: string }
            - { name: priority, type: string }
            - { name: description, type: string }
            - { name: url, type: string }
            - { name: created_by, type: object }
    sla_breach_message:
      type: template
      editor: template
      language: liquid
      label: SLA Breach Alert Message
      description: Urgent Teams message for SLA violations
      default: |
        **SLA BREACH ALERT**

        **{{ issue.title }}**
        Policy: {{ sla.policy_name }}
        Target: {{ sla.target_time }} | Actual: {{ sla.actual_time }}
        **Exceeded by: {{ sla.exceeded_by }}**

        [Take Action Now]({{ issue.url }})
      variables:
        - name: issue
          type: object
        - name: sla
          type: object
          properties:
            - { name: policy_name, type: string }
            - { name: target_time, type: string }
            - { name: actual_time, type: string }
            - { name: exceeded_by, type: string }
      validation:
        required_variables:
          - issue.title
          - sla.policy_name
    approval_request_message:
      type: template
      editor: template
      language: liquid
      label: Approval Request Message
      description: Interactive approval request message for Teams
      default: |
        **Approval Required**

        **{{ issue.title }}**
        Requested by: {{ requester.name }}
        Transition: {{ transition.from }} â†’ {{ transition.to }}

        {% if reason %}
        > {{ reason }}
        {% endif %}
      variables:
        - name: issue
          type: object
        - name: requester
          type: object
          properties:
            - { name: name, type: string }
        - name: transition
          type: object
          properties:
            - { name: from, type: string }
            - { name: to, type: string }
        - name: reason
          type: string
  custom_data:
    permissions:
      - module: dev.kiket.ext.teams.deliveries
        operations: [read, write]
  assets:
    icon: ./public/icon.svg
  hosting: internal
